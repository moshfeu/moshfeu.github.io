{"componentChunkName":"component---src-components-post-js","path":"/test-json-schema-with-ajv-and-jest/","result":{"data":{"site":{"siteMetadata":{"title":"Moshe Feuchtwanger","social":[{"name":"twitter","url":"https://twitter.com/moshfeu"},{"name":"github","url":"https://github.com/moshfeu"},{"name":"linkedin","url":"https://www.linkedin.com/in/moshfeu/"},{"name":"stackoverflow","url":"https://stackoverflow.com/users/863110/mosh-feu"},{"name":"visualstudiocode","url":"https://marketplace.visualstudio.com/publishers/moshfeu"}]}},"mdx":{"id":"f7f72df7-c7bb-5f97-bffa-b9750d8465de","excerpt":"While I worked on a project I was involved (Coding-Coach if you must know ðŸ˜‰) I faced with an interesting challenge. The project usersâ€¦","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"slug\": \"test-json-schema-with-ajv-and-jest\",\n  \"date\": \"2019-03-20T08:48:26.732Z\",\n  \"author\": \"Mosh Feu\",\n  \"title\": \"Test JSON schema with AJV  and Jest\",\n  \"subtitle\": \"Photo by Lacie Slezak on Unsplash\",\n  \"image\": \"08GPdwUfLz3vdVZqg.jpg\",\n  \"images\": [\"08GPdwUfLz3vdVZqg.jpg\"],\n  \"tags\": [\"javascript\", \"jest\", \"ajv\", \"json\", \"validation\"],\n  \"keywords\": [\"javascript\", \"jest\", \"ajv\", \"json\", \"validation\"],\n  \"canonical\": \"https://moshfeu.medium.com/test-json-schema-with-ajv-and-jest-c1d2984234c9\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"While I worked on a project I was involved (Coding-Coach if you must know \\uD83D\\uDE09) I faced with an interesting challenge.\"), mdx(\"p\", null, \"The project users \\u201Cdatabase\\u201D is actually a big JSON file which contains all the entries. (Why? this is for another post)\"), mdx(\"p\", null, \"This file has some restrictions to make sure the data will be consistency. For instance, \\u201Ccountry\\u201D field which its value can be only from a list.\"), mdx(\"p\", null, \"Each user can add himself to that JSON file with PR, and \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://travis-ci.com\"\n  }, \"travis-ci\"), \" is running the test which should verify the schema (among other things).\"), mdx(\"h3\", null, \"So how can we sure the new member added himself with the right schema without review it in each PR?\"), mdx(\"p\", null, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/epoberezkin/ajv\"\n  }, \"AJV\"), \" is \\u201CThe fastest JSON Schema Validator\\u201D. I didn\\u2019t check how fast it is but I can tell that its API is nice, flexible, well documented (except 1 case. We will talk about it later) and I liked to work with it.\"), mdx(\"h2\", null, \"So, how we do this?\"), mdx(\"p\", null, \"TLD\\u2019R include the validation call in a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"it\"), \" spec and fail the test if you get an error from the validation method.\"), mdx(\"p\", null, \"Let\\u2019s take their \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://ajv.js.org/#getting-started\"\n  }, \"example\"), \" as a base:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"var Ajv = require('ajv');\\nvar ajv = new Ajv();\\nvar validate = ajv.compile(schema);\\nvar valid = validate(data);\\nif (!valid) console.log(validate.errors);\\n\")), mdx(\"p\", null, \"Let\\u2019s say, our schema should looks like:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\n  \\\"fullname\\\": \\\"your full name\\\"\\n}\\n\")), mdx(\"p\", null, \"So the user will have a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"fullname\"), \" field and let\\u2019s say has minimum of 2 characters, the validation code will be:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"import users from './users.json';\\n\\nconst shema = {\\n  \\\"type\\\": \\\"array\\\",\\n  \\\"items\\\": {\\n    \\\"type\\\": \\\"object\\\",\\n    \\\"properties\\\": {\\n      \\\"fullname\\\": {\\n        \\\"type\\\": \\\"string\\\",\\n        \\\"minLength\\\": 2\\n      },\\n    },\\n  },\\n};\\n\\najv.validate(shema, users);\\n\")), mdx(\"p\", null, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"users.json\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"[\\n  {\\n    \\\"fullname\\\": \\\"john doe\\\"\\n  }\\n]\\n\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ajv\"), \" object has \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"errors\"), \" property \\u2014 Array with the errors so if the JSON will not meet the schema, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"errors\"), \" will be:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"[\\n  {\\n    keyword: 'minLength',\\n    dataPath: '[0].fullname',\\n    schemaPath: '#/items/properties/fullname/minLength',\\n    params: { limit: 2 },\\n    message: 'should NOT be shorter than 2 characters'\\n  }\\n]\\n\")), mdx(\"h2\", null, \"So far so good but it will not break our test.. Where is the test actually?\"), mdx(\"p\", null, \"It\\u2019s not so hard. We just \\u201Cwrap\\u201D the validation call with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"it\"), \".\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"it.only(`should user's schema be valid`, () => {\\n  const schema = {\\n    \\\"type\\\": \\\"array\\\",\\n    \\\"items\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"fullname\\\": {\\n          \\\"type\\\": \\\"string\\\",\\n          \\\"minLength\\\": 2\\n        },\\n      },\\n    },\\n  };\\n\\n  const valid = ajv.validate(shema, [\\n    {\\n      fullname: 'a'\\n    }\\n  ]);\\n  expect(valid).toBeTruthy();\\n});\\n\\n\")), mdx(\"p\", null, \"In this case, the test will fail with the message:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"\\u25CF should user's schema be valid\\n\\nexpect(received).toBeTruthy()\\n\\nReceived: false\\n\")), mdx(\"p\", null, \"As you can see, I don\\u2019t know what\\u2019s wrong, I just know that the data\\u2019s schema is invalid, it\\u2019s not good enough. It will be better to show more meaningful message.\"), mdx(\"p\", null, \"As we saw earlier, we get the errors from ajv ( \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ajv.errors\"), \" ) remember? So we can display it when the test is failing.\"), mdx(\"p\", null, \"In Jest (unlike other libraries), you can\\u2019t specify the error message. So, in order to display a meaningful error message, we will have to create a \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://jestjs.io/docs/en/expect#expectextendmatchers\"\n  }, \"custom matcher\"), \" to show our own message. We also, collect the field name and the index so we could know which one is the problematic and what field.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"expect.extend({\\n  toBeValid(isValid, errorMessage) {\\n    return {\\n      message: () => isValid ? '' : errorMessage,\\n      pass: isValid\\n    }\\n  }\\n});\\n\\nit(`should user's schema be valid`, () => {\\n  const shema = {\\n    \\\"type\\\": \\\"array\\\",\\n    \\\"items\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"fullname\\\": {\\n          \\\"type\\\": \\\"string\\\",\\n          \\\"minLength\\\": 2\\n        },\\n      },\\n    },\\n  };\\n\\n  const valid = ajv.validate(shema, [\\n    {\\n      fullname: 'a'\\n    }\\n  ]);\\n  try {\\n      const [, index, fieldName] = /\\\\[(.*)\\\\].(.*)/.exec(error.dataPath);\\n      return `error with item #${index}'s field \\\"${fieldName}\\\". The error is: ${error.message}`;\\n    } catch (error) {\\n      return error.message;\\n    }\\n  }).join('\\\\n');\\n  expect(valid).toBeValid(errorMessage);\\n});\\n\\n\")), mdx(\"p\", null, \"This one will show the error message we wanted:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"\\u25CF should user's schema be valid\\n\\nerror with item #0's field \\\"fullname\\\". The error is: should NOT be shorter than 2 characters\\n\")), mdx(\"p\", null, \"The next field I wanted to validate is an avatar URL. It shouldn\\u2019t be a problem because with AJV we get a URL validation \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://ajv.js.org/keywords.html#type\"\n  }, \"out of the box\"), \" (Hint: by using \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"format: \\u2018uri'\"), \").\"), mdx(\"p\", null, \"The problem is, our website is running on \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"https\"), \" schema so we wanted that all the resources will come from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"https\"), \" either (to avoid \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content\"\n  }, \"Mixed Content\"), \" issue). URL with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http\"), \" is valid so how can we verify the the URL schema?\"), mdx(\"p\", null, \"AJV let us to define \\u201CCustom Keywords\\u201D \\u2014 a custom function validation of top of the original function based on the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"type\"), \" of the field.\"), mdx(\"p\", null, \"Here is how:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"const validateSecuredUrl = function (schema, uri) {\\n  return uri.indexOf('https://') === 0;\\n};\\n\\najv.addKeyword('securedUrl', {\\n  validate: validateSecuredUrl,\\n  errors: true\\n});\\n\\nit(`should user's schema be valid`, () => {\\n  const shema = {\\n    \\\"type\\\": \\\"array\\\",\\n    \\\"items\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"fullname\\\": {\\n          \\\"type\\\": \\\"string\\\",\\n          \\\"minLength\\\": 2\\n        },\\n        \\\"avatar\\\": {\\n          \\\"type\\\": \\\"string\\\",\\n          \\\"format\\\": \\\"uri\\\",\\n          \\\"securedUrl\\\": true,\\n        },\\n      },\\n    },\\n  };\\n\\n  const valid = ajv.validate(shema, [\\n    {\\n      fullname: 'ab',\\n      avatar: \\\"http://mywebsite.com/path/to/avatar\\\"\\n    }\\n  ]);\\n  const errorMessage = (ajv.errors || []).map(error => {\\n    try {\\n      const [, index, fieldName] = /\\\\[(.*)\\\\].(.*)/.exec(error.dataPath);\\n      return `error with item #${index}'s field \\\"${fieldName}\\\". The error is: ${error.message}`;\\n    } catch (error) {\\n      return error.message;\\n    }\\n  }).join('\\\\n');\\n  expect(valid).toBeValid(errorMessage);\\n});\\n\\n\")), mdx(\"p\", null, \"And the output will be\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"\\u25CF should user's schema be valid\\n\\nerror with item #0's field \\\"avatar\\\". The error is: should pass \\\"securedUrl\\\" keyword validation\\n\")), mdx(\"p\", null, \"The only thing that left is to display what\\u2019s exactly \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"secureUrl\"), \" validation is.\"), mdx(\"p\", null, \"The docs does mention how to return a custom error message\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The function should return validation result as boolean. It can return an array of validation errors via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".errors\"), \" property of itself (otherwise a standard error will be used).\")), mdx(\"p\", null, \"But I wasn\\u2019t sure how exactly to implement it (whoever thinks that it straightforward, well done \\uD83D\\uDC4F)\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"\\u2026well documented (except 1 case. We will talk about it later)\")), mdx(\"p\", null, \"Remember?\"), mdx(\"p\", null, \"So after diving into the repo in Github, I found the answer in an \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/epoberezkin/ajv/issues/161\"\n  }, \"issue\"), \" who asks exactly that.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"So the full code will be\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"const validateSecuredUrl = function (schema, uri) {\\n  validateSecuredUrl.errors = [{keyword: 'secured', message: 'avatar url must be \\\"https\\\" schema', params: {keyword: 'secured'}}];\\n  return uri.indexOf('https://') === 0;\\n};\\n\\najv.addKeyword('securedUrl', {\\n  validate: validateSecuredUrl,\\n  errors: true\\n});\\n\\nit(`should user's schema be valid`, () => {\\n  const shema = {\\n    \\\"type\\\": \\\"array\\\",\\n    \\\"items\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"fullname\\\": {\\n          \\\"type\\\": \\\"string\\\",\\n          \\\"minLength\\\": 2\\n        },\\n        \\\"avatar\\\": {\\n          \\\"type\\\": \\\"string\\\",\\n          \\\"format\\\": \\\"uri\\\",\\n          \\\"securedUrl\\\": true,\\n        },\\n      },\\n    },\\n  };\\n\\n  const valid = ajv.validate(shema, [\\n    {\\n      fullname: 'ab',\\n      avatar: \\\"http://mywebsite.com/path/to/avatar\\\"\\n    }\\n  ]);\\n  const errorMessage = (ajv.errors || []).map(error => {\\n    try {\\n      const [, index, fieldName] = /\\\\[(.*)\\\\].(.*)/.exec(error.dataPath);\\n      return `error with item #${index}'s field \\\"${fieldName}\\\". The error is: ${error.message}`;\\n    } catch (error) {\\n      return error.message;\\n    }\\n  }).join('\\\\n');\\n  expect(valid).toBeValid(errorMessage);\\n});\\n\")), mdx(\"p\", null, \"And the output will be\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"\\u25CF should user's schema be valid\\n\\nerror with item #0's field \\\"avatar\\\". The error is: avatar url must be \\\"https\\\" schema\\n\")), mdx(\"p\", null, \"And now the user could understand exactly what he / she needs to fix.\"));\n}\n;\nMDXContent.isMDXComponent = true;","slug":"test-json-schema-with-ajv-and-jest/","frontmatter":{"canonical":"https://moshfeu.medium.com/test-json-schema-with-ajv-and-jest-c1d2984234c9","title":"Test JSON schema with AJV  and Jest","subtitle":"Photo by Lacie Slezak on Unsplash","keywords":["javascript","jest","ajv","json","validation"],"tags":["javascript","jest","ajv","json","validation"],"date":"March 20, 2019","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAFV+baVihP/xAAaEAABBQEAAAAAAAAAAAAAAAARAAECAyES/9oACAEBAAEFAqterYhRcKNgbsr/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPwFn/8QAGRAAAgMBAAAAAAAAAAAAAAAAEBEAAQIx/9oACAEBAAY/Ao9Ujwf/xAAbEAEAAgMBAQAAAAAAAAAAAAABABEhMUFRgf/aAAgBAQABPyEADmWsaecI+zMuaj9H2G6p/9oADAMBAAIAAwAAABCv/wD/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/EEsIf//EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8Qlq3/xAAcEAEBAAICAwAAAAAAAAAAAAABEQAhMZFRgdH/2gAIAQEAAT8QEyF2GENuM7EZ28+sBiRHA3OEV8jMcDENX4xBXVz/2Q==","aspectRatio":1.5065502183406114,"src":"/static/92e5e6399bca289e0499961056d109af/a674a/08GPdwUfLz3vdVZqg.jpg","srcSet":"/static/92e5e6399bca289e0499961056d109af/862d9/08GPdwUfLz3vdVZqg.jpg 345w,\n/static/92e5e6399bca289e0499961056d109af/32c8c/08GPdwUfLz3vdVZqg.jpg 690w,\n/static/92e5e6399bca289e0499961056d109af/a674a/08GPdwUfLz3vdVZqg.jpg 1380w,\n/static/92e5e6399bca289e0499961056d109af/9edab/08GPdwUfLz3vdVZqg.jpg 2070w,\n/static/92e5e6399bca289e0499961056d109af/cf519/08GPdwUfLz3vdVZqg.jpg 2760w,\n/static/92e5e6399bca289e0499961056d109af/d2452/08GPdwUfLz3vdVZqg.jpg 4000w","sizes":"(max-width: 1380px) 100vw, 1380px"}}}},"childMdxBlogPost":{"imageAlt":null,"imageCaptionLink":null,"imageCaptionText":null,"socialImage":null}},"previous":{"__typename":"MdxBlogPost","id":"e3dccf9e-2ae4-5548-a443-f41c551cc050","excerpt":"I had an idea in my head for some time - to build an app with  Electron . Itâ€™s part of my try to build with JavaScript apps in any platformâ€¦","slug":"/electron-app-with-full-stack-and-ci-cd-without-boilerplate-possible-part-i/","title":"Electron app with full stack and CI-CD without boilerplate, possible? [Part I]","date":"January 29, 2019"},"next":{"__typename":"MdxBlogPost","id":"a4a967b3-7bab-5a16-a596-cc255230f70b","excerpt":"StackOverflow is one of (if not THE) the top common Q & A websites in the world. When you ask Google a code question, StackOverflowâ€™s resultâ€¦","slug":"/is-stackoverflow-a-friend-how-to-make-it-love-you/","title":"Is StackOverflow a friend? How to make it love you?","date":"June 06, 2019"}},"pageContext":{"id":"a00ba0a6-731f-5d46-b5c3-f4209a1934de","previousId":"e3dccf9e-2ae4-5548-a443-f41c551cc050","nextId":"a4a967b3-7bab-5a16-a596-cc255230f70b","maxWidth":1380,"slug":"test-json-schema-with-ajv-and-jest"}},"staticQueryHashes":["2744905544","3090755652","4064581832","511549514","764694655"]}